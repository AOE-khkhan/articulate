{"version":3,"sources":["../../../server/lib/websocket/index.js"],"names":["schema","model","Joi","string","required","valid","MODEL_ALL","description","subscribePath","publishPath","func","actions","array","items","NOHM_SUB_ALL","isESModel","boolean","module","exports","server","rm","app","WebSockets","Promise","all","_","map","ws","key","validation","validate","error","reject","subscription","factory","getPublish","action","subscribe","event","target","publish","properties","Error"],"mappings":";;AAAA;;AACA;;AACA;;AACA;;;;AAKA,MAAMA,MAAM,GAAG;AACXC,EAAAA,KAAK,EAAEC,aACFC,MADE,GAEFC,QAFE,GAGFC,KAHE,CAGIC,oBAHJ,EAIFC,WAJE,CAIU,OAJV,CADI;AAMXC,EAAAA,aAAa,EAAEN,aACVC,MADU,GAEVC,QAFU,GAGVG,WAHU,CAGE,eAHF,CANJ;AAUXE,EAAAA,WAAW,EAAEP,aACRQ,IADQ,GAERH,WAFQ,CAEI,aAFJ,CAVF;AAaXI,EAAAA,OAAO,EAAET,aACJU,KADI,GAEJC,KAFI,CAEEX,aAAIC,MAAJ,GAAaE,KAAb,CAAmBS,uBAAnB,CAFF,EAGJV,QAHI,GAIJG,WAJI,CAIQ,SAJR,CAbE;AAkBXQ,EAAAA,SAAS,EAAEb,aACNc,OADM,GAENT,WAFM,CAEM,gDAFN;AAlBA,CAAf;;AAuBAU,MAAM,CAACC,OAAP,GAAiB,MAAOC,MAAP,IAAkB;AAAA,QAEJC,EAFI,GAEGD,MAAM,CAACE,GAFV,CAEvB,iBAFuB;AAG/B,QAAMC,UAAU,GAAG,MAAM,yBAAW,GAAX,CAAzB;AAEA,QAAMC,OAAO,CAACC,GAAR,CAAYC,gBAAEC,GAAF,CAAMJ,UAAN,EAAkB,OAAOK,EAAP,EAAWC,GAAX,KAAmB;AAEnD,UAAMC,UAAU,GAAG3B,aAAI4B,QAAJ,CAAaH,EAAb,EAAiB3B,MAAjB,CAAnB;;AACA,QAAI6B,UAAU,CAACE,KAAf,EAAsB;AAElB,aAAOR,OAAO,CAACS,MAAR,CAAgB,kBAAiBJ,GAAI,uBAAsBC,UAAU,CAACE,KAAM,EAA5E,CAAP;AACH;;AACD,QAAI;AACA,UAAIJ,EAAE,CAACZ,SAAP,EAAiB;AACbI,QAAAA,MAAM,CAACc,YAAP,CAAoBN,EAAE,CAACnB,aAAvB;AACH,OAFD,MAEO;AACH,cAAMP,KAAK,GAAG,MAAMmB,EAAE,CAACc,OAAH,CAAWP,EAAE,CAAC1B,KAAd,CAApB;;AACA,YAAI,CAACA,KAAK,CAACkC,UAAN,EAAL,EAAyB;AAErB,iBAAOZ,OAAO,CAACS,MAAR,CAAgB,cAAaL,EAAE,CAAC1B,KAAM,iCAAtC,CAAP;AACH;;AACDkB,QAAAA,MAAM,CAACc,YAAP,CAAoBN,EAAE,CAACnB,aAAvB;AACA,cAAMe,OAAO,CAACC,GAAR,CAAYC,gBAAEC,GAAF,CAAMC,EAAE,CAAChB,OAAT,EAAkB,MAAOyB,MAAP,IAAkB;AAElD,gBAAMnC,KAAK,CAACoC,SAAN,CAAgBD,MAAhB,EAAyBE,KAAD,IAAW;AAAA,kBAE7BC,MAF6B,GAElBD,KAFkB,CAE7BC,MAF6B;AAGrCpB,YAAAA,MAAM,CAACqB,OAAP,CAAeb,EAAE,CAAClB,WAAH,CAAe;AAAEgC,cAAAA,UAAU,EAAEF,MAAM,CAACE;AAArB,aAAf,CAAf,EAAkEF,MAAM,CAACE,UAAzE;AACH,WAJK,CAAN;AAKH,SAPiB,CAAZ,CAAN;AAQH;AACJ,KAnBD,CAoBA,OAAOV,KAAP,EAAc;AAEV,YAAMW,KAAK,CAACX,KAAD,CAAX;AACH;AACJ,GA/BiB,CAAZ,CAAN;AAgCH,CArCD","sourcesContent":["import Joi from 'joi';\nimport _ from 'lodash';\nimport RequireDir from 'require-dir';\nimport {\n    MODEL_ALL,\n    NOHM_SUB_ALL\n} from '../../util/constants';\n\nconst schema = {\n    model: Joi\n        .string()\n        .required()\n        .valid(MODEL_ALL)\n        .description('Model'),\n    subscribePath: Joi\n        .string()\n        .required()\n        .description('subscribePath'),\n    publishPath: Joi\n        .func()\n        .description('publishPath'),\n    actions: Joi\n        .array()\n        .items(Joi.string().valid(NOHM_SUB_ALL))\n        .required()\n        .description('Actions'),\n    isESModel: Joi\n        .boolean()\n        .description('Specifies if the model is using ES as back end')\n};\n\nmodule.exports = async (server) => {\n\n    const { 'redis-messaging': rm } = server.app;\n    const WebSockets = await RequireDir('.');\n\n    await Promise.all(_.map(WebSockets, async (ws, key) => {\n\n        const validation = Joi.validate(ws, schema);\n        if (validation.error) {\n\n            return Promise.reject(`The WebSocket [${key}.js] is not valid.\\n${validation.error}`);\n        }\n        try {\n            if (ws.isESModel){\n                server.subscription(ws.subscribePath);\n            } else {\n                const model = await rm.factory(ws.model);\n                if (!model.getPublish()) {\n\n                    return Promise.reject(`The model [${ws.model}] is not configured to publish.`);\n                }\n                server.subscription(ws.subscribePath);\n                await Promise.all(_.map(ws.actions, async (action) => {\n\n                    await model.subscribe(action, (event) => {\n\n                        const { target } = event;\n                        server.publish(ws.publishPath({ properties: target.properties }), target.properties);\n                    });\n                }));\n            }\n        }\n        catch (error) {\n\n            throw Error(error);\n        }\n    }));\n};\n"],"file":"index.js"}