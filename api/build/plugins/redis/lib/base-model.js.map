{"version":3,"sources":["../../../../server/plugins/redis/lib/base-model.js"],"names":["defaults","SKIP","LIMIT","DIRECTION","Constants","SORT_ASC","getLimit","skip","limit","length","undefined","parsedLimit","filterResults","results","filter","_","isEmpty","match","each","value","attributeName","result","includes","properties","allProperties","property","push","isArray","arrayValue","intersection","isString","toLowerCase","search","manualPaging","direction","field","sorted","sortBy","o","toNumber","id","isNaN","reverse","slice","module","exports","BaseModel","NohmModel","constructor","schema","defaultSortField","current","key","defaultSort","isNil","createInstance","data","parentModels","modified","creationDate","utc","format","modificationDate","save","linkParents","updateInstance","removedParents","findById","unlinkParents","saveInstance","load","findAll","ids","find","loadAllByIds","filteredResults","findAllByIds","count","include","leading","SORT_DESC","sort","Array","loadPromises","map","nohmClass","factory","modelName","err","message","loadedModels","Promise","all","model","removeInstance","silent","remove","searchByField","schemaField","Error","ERROR_FIELD_NOT_FOUND","unique","linkName","linkPromises","parentModel","link","belongs","belongsTo","unlink","export","resultPromises","includePromises","inc","relatedModelsIds","getAll","relatedModel","relatedModels"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport Moment from 'moment';\nimport { NohmModel } from 'nohm';\nimport * as Constants from '../../../util/constants';\n\n//const logger = require('../../../util/logger')({ name: `plugin:redis:base-model` });\nconst defaults = {\n    SKIP: 0,\n    LIMIT: 50,\n    DIRECTION: Constants.SORT_ASC\n};\nconst getLimit = ({ skip, limit, length = undefined }) => {\n\n    let parsedLimit = null;\n    if (!limit) {\n        parsedLimit = null;\n    }\n    else if (skip === undefined) {\n        parsedLimit = [limit, length];\n    }\n    else {\n        parsedLimit = [skip, limit];\n    }\n    return parsedLimit;\n};\n\nconst filterResults = ({ results, filter }) => {\n    if (_.isEmpty(filter)) {\n        return results;\n    }\n    const match = [];\n    _.each(filter, (value, attributeName) => {\n\n        _.each(results, (result) => {\n\n            if (_.includes(match, result)) { //Already matched this value\n                return;\n            }\n            const properties = result.allProperties();\n            const property = properties[attributeName];\n            if (property === null) { //valid attribute but with null value\n                return;\n            }\n            if (property === undefined) { //invalid attribute\n                return match.push(result);\n            }\n            if (_.isArray(property)) {\n                const arrayValue = _.isArray(value) ? value : [value];\n                const intersection = _.intersection(arrayValue, property);\n                if (intersection.length > 0) {\n                    return match.push(result);\n                }\n            }\n            if (_.isString(property)) {\n                if (property.toLowerCase().search(value.toLowerCase()) >= 0) {\n                    return match.push(result);\n                }\n            }\n            else if (property === value) {\n                return match.push(result);\n            }\n        });\n    });\n    return match;\n};\n\nconst manualPaging = ({ results, skip, limit, direction, field }) => {\n\n    let sorted = _.sortBy(results, [(o) => {\n\n        const value = field === 'id' ? _.toNumber(o.id) : _.toNumber(o.property(field));\n        return isNaN(value) ? o.property(field) : value;\n    }]);\n    sorted = direction === Constants.SORT_ASC ? sorted : sorted.reverse();\n    sorted = sorted.slice(skip, limit === -1 ? sorted.length : skip + limit);\n    return sorted;\n};\n\nmodule.exports = class BaseModel extends NohmModel {\n\n    constructor({ schema }) {\n\n        super();\n        this.schema = schema;\n    }\n\n    defaultSortField() {\n\n        let field = null;\n        _.each(this.schema, (current, key) => {\n\n            field = current.defaultSort ? key : field;\n        });\n        return _.isNil(field) ? 'id' : field;\n    };\n\n    //using create() or update() conflicts with functions from NohmModel\n    async createInstance({ data, parentModels, modified }) {\n\n        if (!modified) {\n            data.creationDate = Moment().utc().format();\n            data.modificationDate = Moment().utc().format();\n        }\n        await this.property(data);\n        await this.save();\n        await this.linkParents({ parentModels });\n        return this.allProperties();\n    }\n\n    async updateInstance({ id = null, data, parentModels, removedParents }) {\n\n        if (id) {\n            // loads the model, if there is no id assumes that was already loaded\n            await this.findById({ id });\n        }\n        data.modificationDate = Moment().utc().format();\n        await this.createInstance({ data, modified: true });\n        await this.linkParents({ parentModels });\n        await this.unlinkParents({ parentModels: removedParents });\n    }\n\n    async saveInstance() {\n\n        this.property('modificationDate', Moment().utc().format());\n        await this.save();\n    }\n\n    async findById({ id }) {\n\n        return await this.load(id);\n    }\n\n    async findAll({ skip = defaults.SKIP, limit = defaults.LIMIT, direction = defaults.DIRECTION, field, filter = null }) {\n\n        const ids = await this.find();\n        field = field ? field : this.defaultSortField();\n        if (filter) {\n            const results = await this.loadAllByIds({ ids });\n            const filteredResults = filterResults({ results, filter });\n            return manualPaging({ results: filteredResults, skip, limit, direction, field });\n        }\n        return await this.findAllByIds({ ids, skip, limit, direction, field });\n    }\n\n    async count() {\n\n        const ids = await this.find();\n        return ids.length;\n    }\n\n    async findAllByIds({ ids, skip = defaults.SKIP, limit = defaults.LIMIT, direction = defaults.DIRECTION, field, filter, include }) {\n\n        if (!_.isArray(ids) || ids.leading === 0) {\n            return [];\n        }\n        field = field ? field : this.defaultSortField();\n\n        if (include || filter) {\n            const results = await this.loadAllByIds({ ids });\n            /* if (include.length > 0) {\n                 await this.include({ include, results });\n             }*/\n            const filteredResults = await filterResults({ results, filter });\n            return await manualPaging({ results: filteredResults, skip, limit, direction, field });\n        }\n\n        if (field) {\n            if (field === 'id') {\n                if (direction === Constants.SORT_DESC) {\n                    ids = ids.reverse();\n                }\n                if (limit === -1) {\n                    ids = ids.slice(skip);\n                }\n                else {\n                    ids = ids.slice(skip, skip + limit);\n                }\n            }\n            else {\n                limit = getLimit({ skip, limit, length: ids.length });\n                ids = await this.sort({ field, direction, limit }, ids);\n            }\n        }\n        else {\n            if (limit === -1) {\n                ids = ids.slice(skip, ids.length);\n            }\n            else {\n                ids = ids.slice(skip, skip + limit);\n            }\n        }\n        if (ids.length === 0) {\n            return [];\n        }\n        return await this.loadAllByIds({ ids });\n    }\n\n    async loadAllByIds({ ids }) {\n\n        if (!Array.isArray(ids) || ids.length === 0) {\n            return [];\n        }\n        const loadPromises = ids.map(async (id) => {\n\n            try {\n                return await this.nohmClass.factory(this.modelName, id);\n            }\n            catch (err) {\n                if (!(err && err.message === 'not found')) {\n                    throw err;\n                }\n            }\n        });\n        const loadedModels = await Promise.all(loadPromises);\n        return loadedModels.filter((model) => typeof model !== 'undefined');\n    }\n\n    async removeInstance({ id = null, silent = false } = {}) {\n\n        if (id) {\n            await this.findById({ id });\n        }\n        await this.remove(silent);\n        return true;\n    }\n\n    async searchByField({ field, value }) {\n\n        const schemaField = this.schema[field];\n        if (!schemaField) {\n            throw Error(Constants.ERROR_FIELD_NOT_FOUND);\n        }\n        const ids = await this.find({\n            [field]: value\n        });\n\n        if (ids.length > 0) {\n            if (schemaField.unique) {\n                return await this.findById({ id: ids[0] });\n            }\n            return await this.findAllByIds({ ids });\n        }\n        return [];\n    }\n\n    async linkParents({ parentModels = [], linkName = null }) {\n\n        if (parentModels.length > 0) {\n            const linkPromises = parentModels.map(async (parentModel) => {\n\n                await parentModel.link(this, linkName || this.modelName);\n                await parentModel.save();\n            });\n            await Promise.all(linkPromises);\n        }\n\n    }\n\n    async unlinkParents({ parentModels = [], linkName = null }) {\n\n        if (parentModels.length > 0) {\n            const linkPromises = parentModels.map(async (parentModel) => {\n\n                const belongs = await parentModel.belongsTo(this, linkName || this.modelName);\n                if (!belongs) {\n                    return;\n                }\n                await parentModel.unlink(this, linkName || this.modelName);\n                await parentModel.save();\n            });\n            await Promise.all(linkPromises);\n        }\n    }\n\n    export() {\n\n        const properties = this.allProperties();\n        delete properties.id;\n        return properties;\n    }\n\n    async include({ include, results }) {\n\n        const resultPromises = results.map(async (result) => {\n\n            const includePromises = await include.map(async (inc) => {\n\n                const relatedModelsIds = await result.getAll(inc, inc);\n                const relatedModel = await this.nohmClass.factory(inc);\n                const relatedModels = await relatedModel.loadAllByIds({ ids: relatedModelsIds });\n                //result.property(inc, relatedModels.map((rm) => rm.allProperties()));\n            });\n            return await Promise.all(includePromises);\n        });\n        return await Promise.all(resultPromises);\n    }\n};\n"],"file":"base-model.js"}